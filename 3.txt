Step 0 micro 0 | forward...
Debug: forward - Flattening. Input shape: [4, 1024]
Debug: forward - Embedding. idx_2d shape: [4096]
[Rank 0] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
[Rank 1] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
Debug: forward - Combined emb shape: [4096, 384]
Debug: forward - Layer 0 LN
Debug: forward - Layer 0 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: done.
Debug: forward - Layer 1 LN
Debug: forward - Layer 1 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Final LN
Debug: forward - Final Matmul. x shape: [4096, 384]
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
Debug: forward - Done. Logits shape: [4096, 25152]
Step 0 micro 0 | loss...
Step 0 micro 0 | backward...
Step 0 micro 0 | done.
Step 0 micro 1 | forward...
Debug: forward - Flattening. Input shape: [4, 1024]
Debug: forward - Embedding. idx_2d shape: [4096]
[Rank 0] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
[Rank 1] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
Debug: forward - Combined emb shape: [4096, 384]
Debug: forward - Layer 0 LN
Debug: forward - Layer 0 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Layer 1 LN
Debug: forward - Layer 1 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Final LN
Debug: forward - Final Matmul. x shape: [4096, 384]
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
Debug: forward - Done. Logits shape: [4096, 25152]
Step 0 micro 1 | loss...
Step 0 micro 1 | backward...
Step 0 micro 1 | done.
Step 0 micro 2 | forward...
Debug: forward - Flattening. Input shape: [4, 1024]
Debug: forward - Embedding. idx_2d shape: [4096]
[Rank 1] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
[Rank 0] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
Debug: forward - Combined emb shape: [4096, 384]
Debug: forward - Layer 0 LN
Debug: forward - Layer 0 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Layer 1 LN
Debug: forward - Layer 1 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: done.
Debug: forward - Final LN
Debug: forward - Final Matmul. x shape: [4096, 384]
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
Debug: forward - Done. Logits shape: [4096, 25152]
Step 0 micro 2 | loss...
Step 0 micro 2 | backward...
Step 0 micro 2 | done.
[Rank 0] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
[Rank 1] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
Step 0 micro 3 | forward...
Debug: forward - Flattening. Input shape: [4, 1024]
Debug: forward - Embedding. idx_2d shape: [4096]
Debug: forward - Combined emb shape: [4096, 384]
Debug: forward - Layer 0 LN
Debug: forward - Layer 0 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Layer 1 LN
Debug: forward - Layer 1 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Final LN
Debug: forward - Final Matmul. x shape: [4096, 384]
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
Debug: forward - Done. Logits shape: [4096, 25152]
Step 0 micro 3 | loss...
Step 0 micro 3 | backward...
Step 0 micro 3 | done.
Step 0 micro 4 | forward...
Debug: forward - Flattening. Input shape: [4, 1024]
Debug: forward - Embedding. idx_2d shape: [4096]
[Rank 0] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
[Rank 1] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
Debug: forward - Combined emb shape: [4096, 384]
Debug: forward - Layer 0 LN
Debug: forward - Layer 0 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Layer 1 LN
Debug: forward - Layer 1 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Final LN
Debug: forward - Final Matmul. x shape: [4096, 384]
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
Debug: forward - Done. Logits shape: [4096, 25152]
Step 0 micro 4 | loss...
[Rank 0] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
Step 0 micro 4 | backward...
Step 0 micro 4 | done.
Step 0 micro 5 | forward...
Debug: forward - Flattening. Input shape: [4, 1024]
Debug: forward - Embedding. idx_2d shape: [4096]
[Rank 1] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
Debug: forward - Combined emb shape: [4096, 384]
Debug: forward - Layer 0 LN
Debug: forward - Layer 0 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Layer 1 LN
Debug: forward - Layer 1 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Final LN
Debug: forward - Final Matmul. x shape: [4096, 384]
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
Debug: forward - Done. Logits shape: [4096, 25152]
Step 0 micro 5 | loss...
Step 0 micro 5 | backward...
Step 0 micro 5 | done.
Step 0 micro 6 | forward...
Debug: forward - Flattening. Input shape: [4, 1024]
Debug: forward - Embedding. idx_2d shape: [4096]
[Rank 0] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
[Rank 1] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
Debug: forward - Combined emb shape: [4096, 384]
Debug: forward - Layer 0 LN
Debug: forward - Layer 0 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Layer 1 LN
Debug: forward - Layer 1 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Final LN
Debug: forward - Final Matmul. x shape: [4096, 384]
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
Debug: forward - Done. Logits shape: [4096, 25152]
Step 0 micro 6 | loss...
Step 0 micro 6 | backward...
Step 0 micro 6 | done.
Step 0 micro 7 | forward...
Debug: forward - Flattening. Input shape: [4, 1024]
Debug: forward - Embedding. idx_2d shape: [4096]
[Rank 0] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
[Rank 1] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
Debug: forward - Combined emb shape: [4096, 384]
Debug: forward - Layer 0 LN
Debug: forward - Layer 0 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Layer 1 LN
Debug: forward - Layer 1 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Final LN
Debug: forward - Final Matmul. x shape: [4096, 384]
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
Debug: forward - Done. Logits shape: [4096, 25152]
Step 0 micro 7 | loss...
Step 0 micro 7 | backward...
Step 0 micro 7 | done.
[Rank 0] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
[Rank 1] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
Step 0 micro 8 | forward...
Debug: forward - Flattening. Input shape: [4, 1024]
Debug: forward - Embedding. idx_2d shape: [4096]
Debug: forward - Combined emb shape: [4096, 384]
Debug: forward - Layer 0 LN
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
Debug: forward - Layer 0 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Layer 1 LN
Debug: forward - Layer 1 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Final LN
Debug: forward - Final Matmul. x shape: [4096, 384]
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
Debug: forward - Done. Logits shape: [4096, 25152]
Step 0 micro 8 | loss...
Step 0 micro 8 | backward...
Step 0 micro 8 | done.
Step 0 micro 9 | forward...
Debug: forward - Flattening. Input shape: [4, 1024]
Debug: forward - Embedding. idx_2d shape: [4096]
[Rank 0] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
[Rank 1] KERNEL LAUNCH ERR: embedding_forward_kernel_optimized failed: invalid argument | N=4096, C=384, V=25152, grid=(12,512,1), block=(32,8,1)
Debug: forward - Combined emb shape: [4096, 384]
Debug: forward - Layer 0 LN
Debug: forward - Layer 0 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
[Rank 1] --- MATMUL DIAGNOSTICS --- (Device: 1, Stream: (nil))
  DMLP: done.
Debug: forward - Layer 1 LN
Debug: forward - Layer 1 MLP input shape: [4096, 384]
  DMLP: fc1 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
  DMLP: gelu...
  DMLP: fc2 forward...
[Rank 0] --- MATMUL DIAGNOSTICS --- (Device: 0, Stream: (nil))
blu-bridge005@blubridge005-MS-7E06:~/Desktop/Anuj@BluBridge/Parallelism/Tensor Parallelism/beta/DTensor_v2.0/mlp$ 



Looks like your embedding_forward_kernel_optimized is hitting a wall. Based on the logs, you’ve got an invalid argument error triggered during the embedding layer of your forward pass. 
The culprit is likely your CUDA grid/block configuration relative to your hardware or the kernel's internal logic: 
The Red Flags:
Block Dimensions: Your block is (32, 8, 1), totaling 256 threads. While this is within the 1024-thread limit, if the kernel uses significant Shared Memory or specific registers per thread, it might be failing on allocation.
Grid Dimensions: Your grid is (12, 512, 1). Total blocks = 6,144.
The Parameters:
N=4096 (Total tokens)
C=384 (Embedding dim)
V=25152 (Vocab size) 
Likely Causes & Fixes:
Shared Memory Overflow: If this "optimized" kernel tries to load a portion of the embedding table or intermediate results into Shared Memory based on C or block.y, it might be exceeding the hardware limit (usually 48KB–164KB). Check if the kernel's shared memory requirement is calculated as C * sizeof(float) or similar.
Grid X-Dimension Constraint: In some custom kernels, the grid.x is expected to map exactly to a multiple of the SM count or a specific dimension of the input. A value of 12 is relatively small; check if the kernel expects grid.x to be N / block.x.
Alignment/Pointer Issues: The "invalid argument" often crops up if a pointer passed to the kernel isn't 16-byte aligned, or if a cudaMemcpy failed silently before the launch. Note that your MATMUL DIAGNOSTICS show Stream: (nil), implying you're using the default stream, which can sometimes mask timing issues between ranks. 
Quick Test: Try reverting to a standard nn.Embedding or a non-optimized version of the kernel to see if the error persists. If it disappears, the issue is strictly the launch bounds or shared memory allocation in your optimized CUDA source.
Are you running this on a multi-GPU setup with custom nccl or sharding logic, or is this a single-node distributed test?